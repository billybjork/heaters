name: heaters-ingest-prod
prefect-version: 3

# This explicitly tells Prefect how workers should get the code.
# An empty list means "do nothing, the code is already on the filesystem".
pull:
  - prefect.deployments.steps.set_working_directory:
      directory: /app

deployments:
  - name: scheduled-ingest-dispatcher-prod
    description: Periodically checks PROD DB for new ingest work and triggers tasks/flows.
    entrypoint: flows/initiator_flows.py:scheduled_ingest_initiator # Relative to /app inside container
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule:
      interval: 60 # Can be same as dev, or different
      timezone: "UTC"
      late_runs: skip
    tags: ["ingest", "scheduled", "dispatcher", "production"]
    parameters:
      environment: "production"

  - name: scheduled-clip-cleanup-prod
    description: Periodically cleans up sprites for approved/archived clips in PROD.
    entrypoint: flows/cleanup_flows.py:cleanup_reviewed_clips # Relative to /app
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule:
      cron: "5 0 * * 0"  # Once a week, Sunday at 00:05 UTC
      timezone: "UTC"
      late_runs: skip
    tags: ["cleanup", "scheduled", "maintenance", "production"]
    parameters:
      environment: "production"

  - name: process-clip-post-review-default
    flow_name: process-clip-post-review # Explicit flow_name can be helpful
    description: Processes a single clip after review (keyframing, embedding). Triggered by ingest dispatcher.
    entrypoint: flows/post_review_flows.py:process_clip_post_review # Relative to /app
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule: null
    parameters: {} # Keep parameters, even if empty, for consistency
    tags: ["ingest", "processing", "post-review", "triggered", "production-default"] # Added a more specific tag