# Generic project metadata
name: heaters-ingest
prefect-version: 3

# Define how deployments are built (using `prefect deploy --all`)
build: null

# Define deployments
deployments:
  - name: scheduled-ingest-dispatcher-dev
    description: Periodically checks DEV DB for new ingest work and triggers tasks/flows.
    entrypoint: flows/ingest_flows.py:scheduled_ingest_initiator # Relative to /app inside container
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule:
      interval: 60
      timezone: "UTC"
    tags: ["ingest", "scheduled", "dispatcher", "development"]
    parameters: 
      environment: "development"

  - name: scheduled-ingest-dispatcher-prod
    description: Periodically checks PROD DB for new ingest work and triggers tasks/flows.
    entrypoint: flows/ingest_flows.py:scheduled_ingest_initiator # Relative to /app inside container
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule:
      interval: 60 # Can be same as dev, or different
      timezone: "UTC"
    tags: ["ingest", "scheduled", "dispatcher", "production"]
    parameters:
      environment: "production"

  - name: scheduled-clip-cleanup-dev
    description: Periodically cleans up sprites for approved/archived clips in DEV.
    entrypoint: flows/ingest_flows.py:cleanup_reviewed_clips_flow # Relative to /app
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule:
      cron: "0 0 * * 0"  # Once a week, Sunday at 00:00 UTC
      timezone: "UTC"
    tags: ["cleanup", "scheduled", "maintenance", "development"]
    parameters: 
      environment: "development"

  - name: scheduled-clip-cleanup-prod
    description: Periodically cleans up sprites for approved/archived clips in PROD.
    entrypoint: flows/ingest_flows.py:cleanup_reviewed_clips_flow # Relative to /app
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    schedule:
      cron: "5 0 * * 0"  # Once a week, Sunday at 00:05 UTC
      timezone: "UTC"
    tags: ["cleanup", "scheduled", "maintenance", "production"]
    parameters:
      environment: "production"

  - name: process-clip-post-review-default
    flow_name: process-clip-post-review
    description: Processes a single clip after review (keyframing, embedding). Triggered by ingest dispatcher.
    entrypoint: flows/ingest_flows.py:process_clip_post_review # Relative to /app
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    parameters: {}
    tags: ["ingest", "processing", "post-review", "triggered"]
    
  - name: intake-default
    description: "On‐demand intake from the Phoenix toolbar"
    entrypoint: flows/ingest_flows.py:intake_source_flow
    work_pool:
      name: default-agent-pool
      work_queue_name: default
    parameters:
      environment: "development"  # Default environment, can be overridden by flow run parameters
    tags: ["ingest", "on‐demand"]