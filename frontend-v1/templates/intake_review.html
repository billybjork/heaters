<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Review Clip</title>

  <!-- TODO: Refactor to integrate with index.html, similar to similarity_browser.html -->
  <link rel="stylesheet" href="{{ url_for('static', path='css/global.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/intake-review.css') }}" />
</head>

<body>
  <h1>Review Clip</h1>

  <div class="review-container">
    {% if error %}
      <p style="color: red; text-align: center;">
        Error loading clip: {{ error }}
      </p>
    {% endif %}

    {% if clip %}
      <!-- ── Single‑clip wrapper ─────────────────────────────────────────── -->
      <div
        class="clip-review-item"
        id="clip-{{ clip.clip_db_id }}"
        data-clip-id="{{ clip.clip_db_id }}"
        data-autoplay="true"
        {% if clip.sprite_metadata and not clip.sprite_error %}
          data-sprite-url="{{ clip.sprite_sheet_url }}"
          data-sprite-meta="{{ clip.sprite_metadata|tojson|forceescape }}"
        {% endif %}
        data-clip-fps="{{ clip.sprite_metadata.clip_fps if clip.sprite_metadata else '0' }}"
        data-previous-clip-id="{{ clip.previous_clip_id or '' }}"
      >
        <!-- Clip meta header -->
        <div class="clip-info">
          <strong>{{ clip.title }}</strong>
          (Source: {{ clip.source_title }})<br />
          Clip ID: {{ clip.clip_db_id }} |
          Source ID: {{ clip.source_video_id }} |
          Time: {{ "%.3f"|format(clip.start_time) }} s – {{ "%.3f"|format(clip.end_time) }} s
          {% if clip.sprite_error %}
            | <strong style="color:orange;">Sprite Failed</strong>
          {% endif %}
          | Status:
          <code style="background:#eee; padding:1px 4px; border-radius:3px;">
            {{ clip.current_state }}
          </code>
        </div>

        <!-- Sprite canvas -->
        <div
          class="sprite-viewer"
          id="sprite-viewer-{{ clip.clip_db_id }}"
          tabindex="0"
        >
          Loading sprite…
        </div>

        <!-- Playback controls -->
        <div class="playback-controls" id="controls-{{ clip.clip_db_id }}">
          <button
            class="sprite-play-pause-btn"
            data-clip-id="{{ clip.clip_db_id }}"
            title="Play/Pause (Spacebar)"
          >
            ⏯️
          </button>

          <input
            type="range"
            class="sprite-scrub-bar"
            id="scrub-{{ clip.clip_db_id }}"
            value="0"
            min="0"
            max="100"
            title="Scrub (←/→)"
          />

          <span
            class="sprite-current-frame"
            id="frame-display-{{ clip.clip_db_id }}"
          >
            Frame: 0
          </span>
        </div>

        <!-- Action buttons -->
        <div class="clip-actions">
          <button class="action-btn approve-btn" data-action="approve" title="A + Enter">
            ✅ Approve
          </button>
          <button class="action-btn skip-btn" data-action="skip" title="S + Enter">
            ⏭️ Skip
          </button>
          <button class="action-btn archive-btn" data-action="archive" title="D + Enter">
            🗑️ Archive
          </button>

          <!-- Merge / Group (require previous) -->
          <button
            class="action-btn merge-previous-btn"
            data-action="merge_previous"
            {% if not clip.can_action_previous %}
              disabled
              title="Previous clip unavailable"
            {% else %}
              title="Merge w/ Prev (F + Enter)"
            {% endif %}
          >
          👈 Merge 🔗
          </button>

          <button
            class="action-btn group-previous-btn"
            data-action="group_previous"
            {% if not clip.can_action_previous %}
              disabled
              title="Previous clip unavailable"
            {% else %}
              title="Group w/ Prev (G + Enter)"
            {% endif %}
          >
          👈 Group 🖇️
          </button>

          <!-- Split (requires sprite) -->
          <button
            class="action-btn split-mode-btn"
            data-action="enter_split_mode"
            {% if not clip.sprite_metadata or clip.sprite_error %}
              disabled
              title="Sprite unavailable"
            {% else %}
              title="Split (←/→, Enter)"
            {% endif %}
          >
            ✂️ Split Clip
          </button>

          {% if clip.sprite_error %}
            <button
              class="action-btn retry-sprite-btn"
              data-action="retry_sprite_gen"
              title="Regenerate sprite"
            >
              Retry Sprite
            </button>
          {% endif %}

          <!-- Split controls (hidden by default) -->
          <div class="split-controls" id="split-controls-{{ clip.clip_db_id }}">

            <div class="frame-info">
              Frame&nbsp;<span class="split-confirm-frame">0</span> /
              <span class="split-total-frames">?</span> |
              Time&nbsp;<span class="split-confirm-time">0.00</span>s
            </div>

            <button
              class="action-btn confirm-split-btn"
              data-action="confirm_split"
              disabled
            >
              Confirm (<span class="split-confirm-frame-btn-text">0</span>)
            </button>

            <button
              class="action-btn cancel-split-btn"
              data-action="cancel_split_mode"
              title="Esc"
            >
              Cancel
            </button>

            <br /><span class="split-feedback"></span>
          </div>
        </div>

        <div class="action-feedback"></div>
      </div>

    {% else %}
      <!-- No clip available -->
      <p style="text-align:center; padding:40px 20px; color:#666;">
        {% if error %}
          Could not load a clip for review. Please check server logs.
        {% else %}
          No clips pending review. You’re all caught up 🎉
        {% endif %}
      </p>

      <div style="text-align:center; margin-top:10px;">
        <button onclick="window.location.reload();">Refresh Page</button>
      </div>
    {% endif %}
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', path='js/intake-review.js') }}"></script>
  <script src="{{ url_for('static', path='js/sprite-player.js') }}"></script>
</body>
</html>