# For DEVELOPMENT environment

FROM elixir:1.18.4-otp-26-slim

# Install system-level dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
  build-essential \
  git \
  unzip \
  python3 \
  postgresql-client \
  inotify-tools \
  bash \
  procps \
  curl \
  wget \
  xz-utils \
  && rm -rf /var/lib/apt/lists/*

# Install Bun for fast JavaScript package management and bundling
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Install uv for fast Python package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Install Debian FFmpeg package for proper DNS resolution
RUN apt-get update \
  && apt-get install -y --no-install-recommends ffmpeg \
  && rm -rf /var/lib/apt/lists/* \
  && ffmpeg -version

# Force IPv4 preference to avoid DNS stalls with CloudFront
RUN echo 'precedence ::ffff:0:0/96 100' >> /etc/gai.conf

# --- Set up the Python Virtual Environment ---
RUN uv venv /opt/venv
ENV VIRTUAL_ENV="/opt/venv"
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

# --- Install Python Dependencies into the Virtual Environment ---
WORKDIR /app
COPY py/pyproject.toml py/uv.lock ./py/
RUN uv sync --project py --frozen --no-dev --no-install-project --active

# --- Pre-install Elixir tools ---
RUN mix local.hex --force && \
    mix local.rebar --force

CMD ["/bin/sh"]
