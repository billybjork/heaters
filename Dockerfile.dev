# For DEVELOPMENT environment

FROM elixir:1.18.4-otp-26-slim

# Install system-level dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
  build-essential \
  git \
  unzip \
  python3 \
  postgresql-client \
  inotify-tools \
  bash \
  procps \
  curl \
  wget \
  xz-utils \
  && rm -rf /var/lib/apt/lists/*

# Install Bun for fast JavaScript package management and bundling
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Install uv for fast Python package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Install Debian FFmpeg package for proper DNS resolution
RUN apt-get update \
  && apt-get install -y --no-install-recommends ffmpeg \
  && rm -rf /var/lib/apt/lists/* \
  && ffmpeg -version

# Force IPv4 preference to avoid DNS stalls with CloudFront
RUN echo 'precedence ::ffff:0:0/96 100' >> /etc/gai.conf

# Install Rust for rambo compilation
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:$PATH"

# Verify Rust installation
RUN rustc --version && cargo --version

# --- Set up the Python Virtual Environment ---
RUN uv venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# --- Install Python Dependencies into the Virtual Environment ---
WORKDIR /app
COPY py/requirements.txt ./py/requirements.txt
RUN uv pip install --no-cache -r py/requirements.txt

# --- Pre-install Elixir tools ---
RUN mix local.hex --force && \
    mix local.rebar --force

CMD ["/bin/sh"]