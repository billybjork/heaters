<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Review Clip</title>

  <!-- External stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}" />

  <!-- Inline (component‚Äëscoped) styles -->
  <style>
    /* ---------- Page shell ---------- */
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: sans-serif;
      padding-top: 10px;
      background: #f4f4f4;
    }

    .review-container {
      width: 95%;
      max-width: 700px;
      margin-top: 10px;
      padding: 20px;
      background: #fff;
      border-radius: 5px;
    }

    /* ---------- Clip card ---------- */
    .clip-review-item {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .clip-review-item.processing { opacity: 0.5; }

    .clip-info {
      margin-bottom: 15px;
      padding-bottom: 10px;
      font-size: 0.9em;
      color: #555;
      border-bottom: 1px solid #eee;
    }
    .clip-info strong { color: #333; }

    /* ---------- Sprite viewer ---------- */
    .sprite-viewer {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #222 center / cover no-repeat;
      color: #eee;
      min-height: 90px;
      border: 1px solid #aaa;
      border-radius: 3px;
      font-style: italic;
    }
    .sprite-viewer:focus {
      outline: 2px solid dodgerblue;
      box-shadow: 0 0 5px dodgerblue;
    }
    .sprite-viewer.no-sprite {
      background: none !important;
      min-height: 100px;
      width: 160px;
      border-style: dashed;
    }

    /* ---------- Playback controls ---------- */
    .playback-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .playback-controls button { padding: 5px 10px; font-size: 1.1em; }
    .playback-controls input[type='range'] {
      flex-grow: 1;
      height: 8px;
      cursor: pointer;
      background: #eee;
      border-radius: 4px;
    }
    /* Range thumbs */
    .playback-controls input[type='range']::-webkit-slider-thumb,
    .playback-controls input[type='range']::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: dodgerblue;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .sprite-current-frame {
      min-width: 80px;
      font-family: monospace;
      font-size: 0.9em;
      text-align: right;
      color: #666;
    }

    /* ---------- Split controls ---------- */
    .split-controls {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #eef;
      border: 1px dashed blue;
      border-radius: 4px;
    }
    .split-controls .frame-info {
      display: inline-block;
      margin: 8px 0;
      padding: 8px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-family: monospace;
    }
    .split-feedback {
      margin-left: 10px;
      font-size: 0.9em;
      font-style: italic;
      color: #d00;
      vertical-align: middle;
    }
    .split-feedback:empty { display: none; }

    /* ---------- Buttons ---------- */
    .clip-actions button {
      margin: 5px 3px;
      padding: 9px 14px;
      font-size: 0.95em;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f0f0f0;
      color: #000;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .clip-actions button:hover:not([disabled]) {
      background: #e0e0e0;
      border-color: #bbb;
    }
    .clip-actions button.btn-active {
      background: #333 !important;
      color: #fff !important;
      border-color: #222 !important;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: none;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #eee !important;
      color: #999;
      border-color: #ddd;
    }

    /* --- Semantic button colors --- */
    .approve-btn        { background: #5cb85c; color: #fff; border-color: #4cae4c; }
    .approve-btn:hover  { background: #4cae4c; }

    .archive-btn        { background: #d9534f; color: #fff; border-color: #d43f3a; }
    .archive-btn:hover  { background: #d43f3a; }

    .skip-btn           { background: #f0ad4e; color: #fff; border-color: #eea236; }
    .skip-btn:hover     { background: #eea236; }

    .merge-previous-btn { background: #5bc0de; color: #fff; border-color: #46b8da; }
    .merge-previous-btn:hover { background: #46b8da; }

    .group-previous-btn { background: #7a5bc0; color: #fff; border-color: #6a4db0; }
    .group-previous-btn:hover { background: #6a4db0; }
    .group-previous-btn.btn-active {
      background: #4a2d90 !important;
      border-color: #3a1d70 !important;
    }

    .split-mode-btn     { background: #777; color: #fff; border-color: #666; }
    .split-mode-btn:hover { background: #666; }

    .confirm-split-btn  { background: dodgerblue; color: #fff; border-color: #157fcc; }
    .confirm-split-btn:hover { background: #157fcc; }

    .cancel-split-btn   { background: #aaa; color: #fff; border-color: #999; }
    .cancel-split-btn:hover { background: #999; }

    .retry-sprite-btn   { background: #ffae42; color: #000; border-color: #f09e2a; }
    .retry-sprite-btn:hover { background: #f09e2a; }

    /* ---------- Action feedback ---------- */
    .action-feedback {
      margin-top: 10px;
      height: 1.2em;
      text-align: center;
      font-size: 0.9em;
      font-style: italic;
    }
    .action-feedback.error   { color: #d9534f; }
    .action-feedback.success { color: #5cb85c; }

    /* ---------- Keyboard‚Äëshortcut legend ---------- */
    .keyboard-shortcuts {
      width: 95%;
      max-width: 700px;
      margin-top: 25px;
      padding: 10px 15px;
      text-align: center;
      font-size: 0.85em;
      color: #555;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .keyboard-shortcuts kbd {
      margin: 0 3px;
      padding: 2px 5px;
      font-size: 1.1em;
      font-family: monospace;
      background: #e1e1e1;
      border: 1px solid #ccc;
      border-radius: 3px;
      box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
    }
    .keyboard-shortcuts strong { margin-right: 10px; }
  </style>
</head>

<body>
  <h1>Review Clip</h1>

  <div class="review-container">
    {% if error %}
      <p style="color: red; text-align: center;">
        Error loading clip: {{ error }}
      </p>
    {% endif %}

    {% if clip %}
      <!-- ‚îÄ‚îÄ Single‚Äëclip wrapper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div
        class="clip-review-item"
        id="clip-{{ clip.clip_db_id }}"
        data-clip-id="{{ clip.clip_db_id }}"
        data-autoplay="true"
        {% if clip.sprite_metadata and not clip.sprite_error %}
          data-sprite-url="{{ clip.sprite_sheet_url }}"
          data-sprite-meta="{{ clip.sprite_metadata|tojson|forceescape }}"
        {% endif %}
        data-clip-fps="{{ clip.sprite_metadata.clip_fps if clip.sprite_metadata else '0' }}"
        data-previous-clip-id="{{ clip.previous_clip_id or '' }}"
      >
        <!-- Clip meta header -->
        <div class="clip-info">
          <strong>{{ clip.title }}</strong>
          (Source: {{ clip.source_title }})<br />
          Clip¬†ID: {{ clip.clip_db_id }} |
          Source¬†ID: {{ clip.source_video_id }} |
          Time: {{ "%.3f"|format(clip.start_time) }}‚Ääs ‚Äì {{ "%.3f"|format(clip.end_time) }}‚Ääs
          {% if clip.sprite_error %}
            | <strong style="color:orange;">Sprite Failed</strong>
          {% endif %}
          | Status:
          <code style="background:#eee; padding:1px 4px; border-radius:3px;">
            {{ clip.current_state }}
          </code>
        </div>

        <!-- Sprite canvas -->
        <div
          class="sprite-viewer"
          id="sprite-viewer-{{ clip.clip_db_id }}"
          tabindex="0"
        >
          Loading sprite‚Ä¶
        </div>

        <!-- Playback controls -->
        <div class="playback-controls" id="controls-{{ clip.clip_db_id }}">
          <button
            class="sprite-play-pause-btn"
            data-clip-id="{{ clip.clip_db_id }}"
            title="Play/Pause (Spacebar)"
          >
            ‚èØÔ∏è
          </button>

          <input
            type="range"
            class="sprite-scrub-bar"
            id="scrub-{{ clip.clip_db_id }}"
            value="0"
            min="0"
            max="100"
            title="Scrub (‚Üê/‚Üí)"
          />

          <span
            class="sprite-current-frame"
            id="frame-display-{{ clip.clip_db_id }}"
          >
            Frame:¬†0
          </span>
        </div>

        <!-- Action buttons -->
        <div class="clip-actions">
          <button class="action-btn approve-btn" data-action="approve" title="A + Enter">
            ‚úÖ Approve
          </button>
          <button class="action-btn skip-btn" data-action="skip" title="S + Enter">
            ‚è≠Ô∏è Skip
          </button>
          <button class="action-btn archive-btn" data-action="archive" title="D + Enter">
            üóëÔ∏è Archive
          </button>

          <!-- Merge / Group (require previous) -->
          <button
            class="action-btn merge-previous-btn"
            data-action="merge_previous"
            {% if not clip.can_action_previous %}
              disabled
              title="Previous clip unavailable"
            {% else %}
              title="Merge w/ Prev (F + Enter)"
            {% endif %}
          >
          üëà Merge üîó
          </button>

          <button
            class="action-btn group-previous-btn"
            data-action="group_previous"
            {% if not clip.can_action_previous %}
              disabled
              title="Previous clip unavailable"
            {% else %}
              title="Group w/ Prev (G + Enter)"
            {% endif %}
          >
          üëà Group üñáÔ∏è
          </button>

          <!-- Split (requires sprite) -->
          <button
            class="action-btn split-mode-btn"
            data-action="enter_split_mode"
            {% if not clip.sprite_metadata or clip.sprite_error %}
              disabled
              title="Sprite unavailable"
            {% else %}
              title="Split (‚Üê/‚Üí, Enter)"
            {% endif %}
          >
            ‚úÇÔ∏è Split¬†Clip
          </button>

          {% if clip.sprite_error %}
            <button
              class="action-btn retry-sprite-btn"
              data-action="retry_sprite_gen"
              title="Regenerate sprite"
            >
              Retry¬†Sprite
            </button>
          {% endif %}

          <!-- Split controls (hidden by default) -->
          <div class="split-controls" id="split-controls-{{ clip.clip_db_id }}">

            <div class="frame-info">
              Frame&nbsp;<span class="split-confirm-frame">0</span> /
              <span class="split-total-frames">?</span>¬†|
              Time&nbsp;<span class="split-confirm-time">0.00</span>s
            </div>

            <button
              class="action-btn confirm-split-btn"
              data-action="confirm_split"
              disabled
            >
              Confirm¬†(<span class="split-confirm-frame-btn-text">0</span>)
            </button>

            <button
              class="action-btn cancel-split-btn"
              data-action="cancel_split_mode"
              title="Esc"
            >
              Cancel
            </button>

            <br /><span class="split-feedback"></span>
          </div>
        </div>

        <div class="action-feedback"></div>
      </div>

    {% else %}
      <!-- No clip available -->
      <p style="text-align:center; padding:40px 20px; color:#666;">
        {% if error %}
          Could not load a clip for review. Please check server logs.
        {% else %}
          No clips pending review. You‚Äôre all caught up¬†üéâ
        {% endif %}
      </p>

      <div style="text-align:center; margin-top:10px;">
        <button onclick="window.location.reload();">Refresh Page</button>
      </div>
    {% endif %}
  </div>

  <!-- Scripts -->
  <script src="{{ url_for('static', path='/sprite-player.js') }}"></script>
  <script src="{{ url_for('static', path='/review-actions.js') }}"></script>
  <script src="{{ url_for('static', path='/review-main.js') }}"></script>
</body>
</html>