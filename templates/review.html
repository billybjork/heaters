<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Clip</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
            padding-top: 10px;
            background-color: #f4f4f4;
        }
        .review-container {
            max-width: 700px; /* Max width for content */
            width: 95%; /* Responsive width */
            margin-top: 10px;
            background-color: #fff; /* White background for the review box */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
            border-radius: 5px; /* Slightly rounded corners */
            padding: 20px; /* Inner padding */
        }
        .clip-review-item {
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }
        .clip-review-item.processing {
            opacity: 0.5; /* Visual cue for processing */
        }

        .clip-info {
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .clip-info strong { color: #333; } /* Darker title */
        .clip-actions button {
            margin: 5px 3px;
            padding: 9px 14px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0; /* Default button color */
            color: #000000;
            font-size: 0.95em;
            transition: background-color 0.2s ease;
        }
        /* --- Style for button when corresponding key is held down --- */
        .clip-actions button.btn-active {
            background-color: #333 !important; /* Darker background */
            color: white !important;          /* White text */
            border-color: #222 !important;     /* Darker border */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3); /* Inset shadow for pressed look */
            /* Prevent transition for instant feedback */
            transition: none;
        }
        .clip-actions button:hover:not([disabled]) {
            background-color: #e0e0e0;
            border-color: #bbb;
        }
        .action-feedback {
            font-style: italic;
            margin-top: 10px;
            font-size: 0.9em;
            height: 1.2em;
            text-align: center;
        }
        .action-feedback.error { color: #d9534f; }
        .action-feedback.success { color: #5cb85c; }

        /* --- Sprite Viewer Styles --- */
        .sprite-viewer {
            background-size: cover; /* Keep default, JS overrides */
            background-repeat: no-repeat;
            border: 1px solid #aaa;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden; /* Clips the background image */
            background-color: #222; /* Dark background for contrast */
            color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            min-height: 90px; /* Ensure some height even when loading */
            border-radius: 3px;
            /* Default size will be set by JS based on metadata */
        }
        .sprite-viewer:focus { /* Style when focused for keyboard input */
            outline: 2px solid dodgerblue;
            box-shadow: 0 0 5px dodgerblue;
        }
        .sprite-viewer.no-sprite {
            background-image: none !important;
            /* Give it a default size when no sprite */
            min-height: 100px;
            width: 160px;
            border-style: dashed; /* Indicate missing sprite */
        }

        /* --- Playback Controls --- */
        .playback-controls {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-bottom: 15px;
        }
        .playback-controls button {
            padding: 5px 10px;
            font-size: 1.1em;
        }
        .playback-controls input[type=range] {
            flex-grow: 1; /* Allow range slider to take up space */
            cursor: pointer;
            height: 8px;
            background: #eee;
            border-radius: 4px;
        }
        /* --- Style scrub bar thumb (cross-browser) --- */
        .playback-controls input[type=range]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 16px;
          height: 16px;
          background: dodgerblue;
          border-radius: 50%;
          cursor: pointer;
        }
        .playback-controls input[type=range]::-moz-range-thumb {
          width: 16px;
          height: 16px;
          background: dodgerblue;
          border-radius: 50%;
          cursor: pointer;
          border: none;
        }
        .sprite-current-frame {
             font-family: monospace;
             font-size: 0.9em;
             min-width: 80px; /* Prevent layout shift */
             text-align: right;
             color: #666;
        }

        /* --- Split Controls Styles --- */
        .split-controls {
             display: none; /* Hidden by default */
             margin-top: 15px;
             border: 1px dashed blue;
             padding: 15px;
             background-color: #eef;
             border-radius: 4px;
        }
        .split-controls .frame-info {
            font-family: monospace;
            margin: 8px 0;
            background-color: #fff;
            padding: 8px;
            border: 1px solid #ccc;
            display: inline-block;
            border-radius: 3px;
        }
        .split-feedback {
            margin-left: 10px;
            font-style: italic;
            color: #d00; /* Default to error color */
            font-size: 0.9em;
            display: inline-block;
            vertical-align: middle;
        }
        .split-feedback:empty {
             display: none; /* Hide if no feedback */
        }

        /* --- General Button Styles --- */
        button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #eee !important; /* Override hover/active states */
            color: #999;
            border-color: #ddd;
        }
        .approve-btn { background-color: #5cb85c; color: white; border-color: #4cae4c;}
        .approve-btn:hover:not([disabled]) { background-color: #4cae4c; }
        .archive-btn { background-color: #d9534f; color: white; border-color: #d43f3a;}
        .archive-btn:hover:not([disabled]) { background-color: #d43f3a; }
        .skip-btn { background-color: #f0ad4e; color: white; border-color: #eea236;}
        .skip-btn:hover:not([disabled]) { background-color: #eea236; }
        .merge-previous-btn { background-color: #5bc0de; color: white; border-color: #46b8da;}
        .merge-previous-btn:hover:not([disabled]) { background-color: #46b8da; }
        .split-mode-btn { background-color: #777; color: white; border-color: #666;}
        .split-mode-btn:hover:not([disabled]) { background-color: #666; }
        .confirm-split-btn { background-color: dodgerblue; color: white; border-color: #157fcc;}
        .confirm-split-btn:hover:not([disabled]) { background-color: #157fcc; }
        .cancel-split-btn { background-color: #aaa; color: white; border-color: #999;}
        .cancel-split-btn:hover:not([disabled]) { background-color: #999; }
        .retry-sprite-btn {
            background-color: #ffae42;
            color: black;
            border-color: #f09e2a;
        }
        .retry-sprite-btn:hover:not([disabled]) { background-color: #f09e2a; }

        /* --- Keyboard Shortcuts Hint --- */
        .keyboard-shortcuts {
            margin-top: 25px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            background-color: #f8f8f8;
            font-size: 0.85em;
            text-align: center;
            color: #555;
            border-radius: 4px;
            width: 95%;
            max-width: 700px;
        }
        .keyboard-shortcuts kbd {
             background-color: #e1e1e1;
             border: 1px solid #ccc;
             border-radius: 3px;
             padding: 2px 5px;
             font-family: monospace;
             margin: 0 3px;
             box-shadow: 1px 1px 1px rgba(0,0,0,0.1);
             font-size: 1.1em;
        }
        .keyboard-shortcuts strong { margin-right: 10px;}
    </style>
</head>
<body>
    <h1>Review Clip</h1>

    <div class="review-container">
        {% if error %}
            <p style="color: red; text-align: center;">Error loading clip: {{ error }}</p>
        {% endif %}

        {% if clip %}
            {# --- Single Clip Item Div --- #}
            <div class="clip-review-item"
                 id="clip-{{ clip.clip_db_id }}"
                 data-clip-id="{{ clip.clip_db_id }}"
                 data-autoplay="true" {# Signal for JS to autoplay #}
                 {% if clip.sprite_metadata and not clip.sprite_error %}
                 data-sprite-url="{{ clip.sprite_sheet_url }}"
                 data-sprite-meta="{{ clip.sprite_metadata|tojson|forceescape }}"
                 {% endif %}
                 data-clip-fps="{{ clip.sprite_metadata.clip_fps if clip.sprite_metadata else '0' }}"
                 data-previous-clip-id="{{ clip.previous_clip_id if clip.previous_clip_id else '' }}" {# Pass previous ID for context/merge checks #}
                 >

                {# --- Clip Info Header --- #}
                <div class="clip-info">
                    <strong>{{ clip.title }}</strong> (Source: {{ clip.source_title }})<br>
                    Clip ID: {{ clip.clip_db_id }} | Source ID: {{ clip.source_video_id }} | Time: {{ "%.3f"|format(clip.start_time) }}s - {{ "%.3f"|format(clip.end_time) }}s
                     {% if clip.sprite_error %} | <strong style="color:orange;">Sprite Failed</strong> {% endif %}
                     | Current State: <code style="background-color:#eee; padding: 1px 4px; border-radius: 3px;">{{ clip.current_state }}</code>
                </div>

                {# --- Sprite Viewer --- #}
                <div class="sprite-viewer" id="sprite-viewer-{{ clip.clip_db_id }}" tabindex="0"> {# tabindex makes it focusable #}
                     Loading sprite...
                 </div>

                {# --- Playback Controls --- #}
                <div class="playback-controls" id="controls-{{ clip.clip_db_id }}">
                     <button class="sprite-play-pause-btn" data-clip-id="{{ clip.clip_db_id }}" title="Play/Pause (Spacebar)">⏯️</button>
                     <input type="range" class="sprite-scrub-bar" id="scrub-{{ clip.clip_db_id }}" value="0" min="0" max="100" title="Scrub through frames (←/→ Arrows)">
                     <span class="sprite-current-frame" id="frame-display-{{ clip.clip_db_id }}">Frame: 0</span>
                </div>

                {# --- Action Buttons (primarily visual feedback/backup) --- #}
                <div class="clip-actions">
                    <button class="action-btn approve-btn" data-action="approve" title="Approve (A + Enter)">✅ Approve</button>
                    <button class="action-btn skip-btn" data-action="skip" title="Skip (S + Enter)">⏭️ Skip</button>
                    <button class="action-btn archive-btn" data-action="archive" title="Archive (D + Enter)">🗑️ Archive</button>
                    <button class="action-btn merge-previous-btn" data-action="merge_previous" {% if not clip.can_merge_previous %}disabled title="Previous clip not available or not in a mergeable state"{% else %}title="Merge WITH Previous (Cmd/Ctrl + F + Enter)"{% endif %}>🖇️ Merge w/ Prev</button>

                    <button class="action-btn split-mode-btn"
                            data-action="enter_split_mode"
                            {% if not clip.sprite_metadata or clip.sprite_error %}disabled title="Sprite unavailable or failed, cannot split"{% else %}title="Split (Arrow Keys to enter mode & select frame, Enter to confirm)"{% endif %} >
                        ✂️ Split Clip
                    </button>

                     {% if clip.sprite_error %}
                     <button class="action-btn retry-sprite-btn" data-action="retry_sprite_gen" title="Attempt to regenerate the sprite sheet">Retry Sprite</button>
                     {% endif %}

                    {# --- Split Controls Panel (hidden by default) --- #}
                    <div class="split-controls" id="split-controls-{{ clip.clip_db_id }}">
                         <span>Select frame (<kbd>←</kbd> <kbd>→</kbd>), <kbd>Enter</kbd> to Confirm, <kbd>Esc</kbd> to Cancel</span><br>
                         <div class="frame-info">
                             Frame: <span class="split-confirm-frame">0</span>/<span class="split-total-frames">?</span> |
                             Time: <span class="split-confirm-time">0.00</span>s
                         </div>
                         <button class="action-btn confirm-split-btn" data-action="confirm_split" disabled>Confirm Split (<span class="split-confirm-frame-btn-text">0</span>)</button>
                         <button class="action-btn cancel-split-btn" data-action="cancel_split_mode" title="Cancel split (Esc)">Cancel</button>
                         <br><span class="split-feedback"></span> {# Feedback message area #}
                    </div>
                    {# Undo Button Removed #}
                </div>

                {# --- Action Feedback Area --- #}
                <div class="action-feedback"></div>
            </div>

        {% else %}
             {# Message when no clips are left or initial load fails cleanly #}
             <p style="text-align: center; padding: 40px 20px; color: #666;">
                {% if error %}
                     Could not load a clip for review. Please check server logs or try again later.
                {% else %}
                     No clips currently pending review. You're all caught up! 🎉
                {% endif %}
             </p>
             {# Optionally add a button to trigger a manual Prefect initiator run or refresh #}
             <div style="text-align: center; margin-top: 10px;">
                 <button onclick="window.location.reload();">Refresh Page</button>
             </div>
        {% endif %}
    </div> {# End review-container #}

    {# --- Keyboard Shortcuts Hint (outside the container) --- #}
    <div class="keyboard-shortcuts">
         <strong>Shortcuts:</strong>
         <kbd>A</kbd>+<kbd>Enter</kbd>: Approve |
         <kbd>S</kbd>+<kbd>Enter</kbd>: Skip |
         <kbd>D</kbd>+<kbd>Enter</kbd>: Archive |
         <kbd>⌘/Ctrl</kbd>+<kbd>F</kbd>+<kbd>Enter</kbd>: Merge w/ Prev |
         <kbd>←</kbd>/<kbd>→</kbd>: Split Mode/Scrub |
         <kbd>Space</kbd>: Play/Pause |
         <kbd>Enter</kbd>: Confirm Split |
         <kbd>Esc</kbd>: Cancel Split
    </div>

    {# --- Load Javascript --- #}
    <script src="{{ url_for('static', path='/sprite-player.js') }}"></script>
    {# Load updated action handler and main logic JS #}
    <script src="{{ url_for('static', path='/review-actions.js') }}"></script>
    <script src="{{ url_for('static', path='/review-main.js') }}"></script>
</body>
</html>