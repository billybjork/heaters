# Production Deployment Guide

## Overview

Heaters deploys on Render using Docker containers, with PostgreSQL, AWS S3/CloudFront for media storage, and Oban for background job processing. Clip playback uses pre-generated temp files via FFmpeg stream copy — there is no on-demand FFmpeg streaming in the request path.

## Architecture

```
Browser → CloudFront (signed URLs) → S3 Proxy Files
                                          ↑
Phoenix App (Render) → Oban Workers → FFmpeg stream copy → temp clips / exported clips
       ↓
  PostgreSQL (Render)
```

**Key Technologies:**
- **Application**: Phoenix LiveView on Render (Docker)
- **CDN/Storage**: AWS S3 + CloudFront (presigned URLs for proxy files)
- **Database**: PostgreSQL 16 on Render with pgvector
- **Background Jobs**: Oban with queue-based worker separation
- **Media Processing**: FFmpeg stream copy from CloudFront URLs (no local downloads)

## Render Service Configuration

Defined in `render.yaml`:

- **phoenix-web** (web service): Handles HTTP traffic, runs `default` Oban queue (cron scheduler, light jobs). Does NOT run heavy media processing queues.
- **app-db** (PostgreSQL 16): Primary database with pgvector extension.

### Oban Queue Architecture

Production queues are configured via the `OBAN_QUEUES` environment variable:

- **Web service** (`OBAN_QUEUES=default`): Runs cron scheduler (Dispatcher every minute, CleanupWorker every 4 hours)
- **Worker service** (if separated): Runs `media_processing`, `exports`, `temp_clips`, `background_jobs`, `maintenance` queues

See `config/runtime.exs` for dynamic queue configuration.

### Required Environment Variables

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string (from Render) |
| `SECRET_KEY_BASE` | Phoenix secret key |
| `PHX_HOST` | Public hostname for URL generation |
| `APP_ENV` | `production` |
| `OBAN_QUEUES` | Comma-separated queue names to run |
| `PROD_S3_BUCKET_NAME` | S3 bucket for media storage |
| `PROD_CLOUDFRONT_DOMAIN` | CloudFront distribution domain |
| AWS credentials | `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` |

## Playback Cache (Production)

Temp clips are generated by `PlaybackCache.Worker` on the `:temp_clips` Oban queue:
- FFmpeg stream-copies segments from CloudFront proxy URLs to local `/tmp/clip_{id}_{timestamp}.mp4`
- `CleanupWorker` runs every 4 hours: expires files >15 min old, enforces 1GB LRU limit, monitors disk space (500MB threshold)
- Configuration in `config/config.exs` under `:heaters, :playback_cache`

## Deployment Checklist

### Pre-Deployment
- [ ] FFmpeg available in Docker image
- [ ] Environment variables configured in Render
- [ ] S3 bucket and CloudFront distribution created
- [ ] Database migrations applied

### Post-Deployment
- [ ] Verify health check endpoint responds
- [ ] Confirm Oban cron jobs are scheduling (check logs for Dispatcher)
- [ ] Test clip playback in review interface
- [ ] Monitor Oban job queues for failures
- [ ] Verify S3/CloudFront connectivity

## Troubleshooting

**Clip playback not working:**
- Check Oban `:temp_clips` queue is running on the correct service
- Verify proxy files exist in S3 for the source video
- Review `PlaybackCache.Worker` logs for FFmpeg errors

**Oban jobs not running:**
- Confirm `OBAN_QUEUES` env var includes the needed queues
- Check that the `default` queue service is running (required for cron scheduling)

**Disk space issues:**
- `CleanupWorker` logs cache statistics every 4 hours
- Adjust `:playback_cache` config if temp files accumulate
